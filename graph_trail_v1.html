<!DOCTYPE HTML>
<html>
<head>
<script>
var showingF = true;
var tempEdit = true;
var phoneEdit = true;

var phoneNumber;
var minTemp;
var maxTemp;

var init = true;
window.onload = buildGraph;

//NEW VARS TO PREVENT ZOOM ISSUE
var axisXMax = 0, axisXMin = 0;
var axisX = {};
var updateRange = 0;
var resetFlag = false;

/*
TO ADD:

POST reuqests to send new min, max, and phone number

if the third box switch is off, a message “no data available” should appear
instead of the real-time temperature. 



*/


var update = setInterval(buildGraph, 3000);

function buildGraph(){

var recievedData = JSON.parse(getData());		//get data from our server
console.log(recievedData);

if(recievedData.message == "Internal Server Error"){
	document.getElementById("errors").innerHTML = "<h2>Internal Server Error. No data to show.</h2>";
	return
}
else{
	document.getElementById("errors").innerHTML = "";
}

var times = recievedData.data["Time(s)"];
var tempF = recievedData.data["Temp(F)"];
var tempC = recievedData.data["Temp(C)"];

minTemp = recievedData.data["min_temp"];
maxTemp = recievedData.data["max_temp"];
phoneNumber = "" + recievedData.data["area_code"] + recievedData.data["phone_number"];

if(init){
	document.getElementById("minTemp").value = minTemp;
	document.getElementById("maxTemp").value = maxTemp;
	document.getElementById("phoneNum").value = phoneNumber;
	init = false;
}

var limit = 300;		//number y-axis data points
var y = 50;    			//starting point of the data (only applicable for the example)
var data = [];								//var to hold the temp information
var dataSeries = { type: "line"};			//type of graph
var dataPoints = [];						//adds the current data point to the data var for graphing
var newestTemp;


for(var i = 0; i < limit; i++){						//this is where we will load our data
	if(i > 0 && times[i] - times[i-1] > 1){
		document.getElementById("warnings").innerHTML = "<h2>The sensor has been disconnected!!!</h2>";
		y = null;
	}
	else if(showingF){
		y = tempF[i];
		document.getElementById("warnings").innerHTML = "";
	}
	else{
		y = tempC[i];
		document.getElementById("warnings").innerHTML = "";
	}

	if(tempF[i] > maxTemp || tempF[i] < minTemp){
		dataPoints.push({
			x: i,
			y: y,
			lineColor:"red",
			markerColor: "red", markerType: "cross"
		});
	}
	else{
		dataPoints.push({
			x: i,
			y: y
		});
	}
	if(i == 299){
		newestTemp = y;
	}
}
dataSeries.dataPoints = dataPoints;
data.push(dataSeries);

var title;
var min;
var max;
if(showingF){
	title = "Temperature in F";
	min = 50;
	max = 122;
}
else{
	title = "Temperature in C";
	min = 10;
	max = 50;
}

var xLabel = "seconds ago from the current time";
var options = {
	zoomEnabled: true,
	rangeChanged: function(e) {
		if(e.trigger === "zoom") {
			axisXMax = e.axisX[0].viewportMaximum + 1;
      		axisXMin = e.axisX[0].viewportMinimum + 1;
      		resetFlag = false;
      		if( updateRange > 0 ) 
      			clearInterval(updateRange);
      		updateRange = setInterval(updateAxisRange(), 1000); 
      	} 
      	else if(e.trigger == "reset") {
      		resetFlag = true;
      		clearInterval(updateRange);
      	}
    },
	animationEnabled: false,		//adds the special effect on startup/refresh
	title: {
		text: title
	},
	axisY: {
		lineThickness: 1,
		includeZero: true,
		minimum: min,
		maximum: max
	},
	axisX: {
		text: xLabel
	},
	data: data  // temp data
};

var chart = new CanvasJS.Chart("chartContainer", options);

var startTime = new Date();		//start render timer
chart.render();					//adds the data to the chart
var endTime = new Date();		//end render timer
document.getElementById("timeToRender").innerHTML = "Time to Render: " + (endTime - startTime) + "ms";	//time to render info
document.getElementById("whiteCover").innerHTML = "this will cover";	//white cover
var unit = "F";
if(!showingF){
	unit = "C";
}
document.getElementById("tempDisplay").innerHTML = newestTemp + " degrees " + unit;
}

function updateAxisRange(){    	   	
  axisXMax += 1;
  axisXMin += 1;
  chart.options.axisX.viewportMaximum = axisXMax;
  chart.options.axisX.viewportMinimum = axisXMin;
  chart.render();		
}


function changeButton(){
	if(showingF){
		document.getElementById("tempButton").classList.add("tempFButton");
		document.getElementById("tempButton").classList.remove("tempCButton");
		document.getElementById("tempButton").innerHTML = "Show Fahrenheit";
	}
	else{
		document.getElementById("tempButton").classList.add("tempCButton");
		document.getElementById("tempButton").classList.remove("tempFButton");
		document.getElementById("tempButton").innerHTML = "Show Celsius";
	}
	showingF = !showingF;
	getData();
	buildGraph();
}

//STILL NEED TO SEND WHETHER ON OR OFF!!!
function changeDisplay(){
	var on = true;
	if(document.getElementById("displayButton").innerHTML == "Turn on display"){
		document.getElementById("displayButton").innerHTML = "Turn off display";
		on = true;
	}
	else{
		document.getElementById("displayButton").innerHTML = "Turn on display";
		on = false;
	}
	postData(on);
	console.log(postData(on));
}

function postData(on){
	var xmlHttp = new XMLHttpRequest();
	if(on){
		xmlHttp.open( "POST", "http://192.168.0.146:5010/users?LCDStatus=\"ON\"", false );
	}
	else{
		xmlHttp.open( "POST", "http://192.168.0.146:5010/users?LCDStatus=\"OFF\"", false );
	}
	xmlHttp.send(null);
    return xmlHttp.response;
}

function getData(){
	var xmlHttp = new XMLHttpRequest();
	xmlHttp.open( "GET", "http://192.168.0.146:5010/users", false ); // false for synchronous request
    xmlHttp.send(null);
    return xmlHttp.response;
}

function editMaxMin(){

	if(tempEdit){
		document.getElementById("maxTemp").readOnly = false;
		document.getElementById("minTemp").readOnly = false;
		document.getElementById("editTempsButton").innerHTML = "Submit";
	}
	else{
		var min = document.getElementById("minTemp").value;
		var max = document.getElementById("maxTemp").value;
		if (isNaN(min) && isNaN(max)){
			alert("The inputs for the minimum and maximum temperatures must be numbers!");
			document.getElementById("minTemp").value = minTemp;
			document.getElementById("maxTemp").value = maxTemp;
		}
		else if (isNaN(min)){
			alert("The input for the minimum temperature must be a number!");
			document.getElementById("minTemp").value = minTemp;
		}
		else if (isNaN(max)){
			alert("The input for the maximum temperature must be a number!");
			document.getElementById("maxTemp").value = maxTemp;
		}
		else if (parseInt(min) >= parseInt(max)){
			alert("The minimum temperature must be greater than the maximum temperature!");
			document.getElementById("minTemp").value = minTemp;
			document.getElementById("maxTemp").value = maxTemp;
		}
		document.getElementById("maxTemp").readOnly = true;
		document.getElementById("minTemp").readOnly = true;
		document.getElementById("editTempsButton").innerHTML = "Edit";
		//Call POST to send new ranges
	}
	tempEdit = !tempEdit;
}

function editPhone(){

	if(phoneEdit){
		document.getElementById("phoneNum").readOnly = false;
		document.getElementById("editPhoneButton").innerHTML = "Submit";
	}
	else{
		var phone = document.getElementById("phoneNum").value;
		if (isNaN(phone)){
			alert("The input for a phone number must be all number!");
			document.getElementById("phoneNum").value = phoneNumber;
		}
		else if(phone.length != 10){
			alert("The input for a phone number must be 10 digits long!");
			document.getElementById("phoneNum").value = phoneNumber;
		}

		document.getElementById("phoneNum").readOnly = true;
		document.getElementById("editPhoneButton").innerHTML = "Edit";
		//Call POST to send new phone number
	}
	phoneEdit = !phoneEdit;
}

</script>
<style>

	body {
		text-align: center;
		margin-top: 50px;
		background-color: skyblue;
		border:5px;
		border-style:solid;
		border-color:yellow;
		margin-right: 200px;
		margin-left: 200px;
		border-radius: 10px;
		padding: 1em;
	 }

	 minLabel {
		position:absolute; 
		top: 400px;
		left: 205px;
	 }

	 maxLabel {
		position:absolute; 
		top: 425px;
		left: 205px;
	 }

	 phoneLabel {
	 	position:absolute; 
		top: 400px;
		left: 650px;
	 }

	 #tempDisplay {
	 	position:absolute; 
		top: 80px;
	  	right: 335px;
		font-size: 24px; 
		font-weight: bold; 
		background-color: white;
		padding: 0px 4px;
		color: red;
	 }

	#timeToRender {
		position:absolute; 
		top: 71px;
		left: 221px;
		font-size: 20px; 
		font-weight: bold; 
		background-color: #d85757;
		padding: 0px 4px;
		color: #ffffff;
	}

	#whiteCover {
		position:absolute; 
		top: 352px;
	  	right: 223px;
		font-size: 16px; 
		font-weight: bold; 
		background-color: white;
		padding: 0px 4px;
		color: white;
	}

	.displayButton {
	  position: absolute;
	  top: 450px;
	  right: 210px;
	  padding: 10px 24px;
	  font-size: 16px;
	  margin: 4px 2px;
	  transition-duration: 0.4s;
	  cursor: pointer;
	}

	.editTempsButton {
	  position: absolute;
	  top: 448px;
	  left: 425px;
	  padding: 10px 24px;
	  font-size: 16px;
	  margin: 4px 2px;
	  transition-duration: 0.4s;
	  cursor: pointer;
	}

	.editPhoneButton {
	  position: absolute;
	  top: 422px;
	  left: 780px;
	  padding: 10px 24px;
	  font-size: 16px;
	  margin: 4px 2px;
	  transition-duration: 0.4s;
	  cursor: pointer;
	}

	.button {
	  position: absolute;
	  top: 400px;
	  right: 210px;
	  padding: 10px 24px;
	  font-size: 16px;
	  margin: 4px 2px;
	  transition-duration: 0.4s;
	  cursor: pointer;
	}
	
	.tempCButton {
	  background-color: #3333ff;
	  color: white;
	  border: 2px solid #555555;
	}
	
	.tempCButton:hover {
	  background-color: #555555;
	  color: white;
	}

	.tempFButton {
	  background-color: #33cc33;
	  color: black;
	  border: 2px solid #555555;
	}
	
	.tempFButton:hover {
	  background-color: #555555;
	  color: white;
	}
	
</style>
</head>
<body>
	<!-- used to get temp data-->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>

<div id="errors"></div>

<div id="chartContainer" style="height: 300px; width: 100%;"></div>
<span id="timeToRender"></span>
<script src="https://canvasjs.com/assets/script/canvasjs.min.js"></script>

<div id="warnings"></div>

<!-- Add the button ... will start by showing Fahrenheit temps-->
<button class="button tempCButton"id="tempButton"type="button"onclick=changeButton()>Show Celsius</button>

<button class="displayButton"id="displayButton"type="button"onclick=changeDisplay()>Turn on display</button>

<button class="editTempsButton"id="editTempsButton"type="button"onclick=editMaxMin()>Edit</button>

<button class="editPhoneButton"id="editPhoneButton"type="button"onclick=editPhone()>Edit</button>


<span id="whiteCover"></span>

<span id="tempDisplay"></span>

</body>

<maxLabel>
Maximum temperature (in F):  <input type="text" id="maxTemp" value="90" readonly>
</maxLabel>

<minLabel>
Mimimum temperature (in F): <input type="text" id="minTemp" value="50" readonly>
</minLabel>

<phoneLabel>
Phone number: <input type="text" id="phoneNum" value="" readonly>
</phoneLabel>

</html>





